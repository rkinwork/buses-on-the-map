# Автобусы на карте Москвы

Веб-приложение показывает передвижение автобусов на карте Москвы. В качестве источника используется фейковый сервис

<img src="screenshots/buses.gif">

## Требования

- [pyenv](https://github.com/pyenv/pyenv) - если хотим запустить тесты или запустить локально.
- [docker](https://www.docker.com/) - если хотим запустить демо

## Как запустить

- Склонируйте репозиторий себе на локальный компьютер

### Демо

- в директории с проектом выполните команду `make demo`
- После того как сборка завершиться откройте http://127.0.0.1:8888/
- Что бы корректно завершить `make stop`

### Для разработки и тестов

Подготовим окружение

```shell
git clone git@github.com:rkinwork/buses-on-the-map.git
cd buses-on-the-map
```

Запустим тесты

```shell
make test
```

#### Локальный запуск

- в терминале ```make start```
- открываем броузер http://127.0.0.1:8888/
- ```make stop``` что бы завершить работу

## Настройки бэкенд

Все настройки задаются как через аргументы, так и через переменные окружения.

### server.py

Полный список ```python server.py -h```

| Аргумент        | Описание                                      | По-умолчанию |
|-----------------|-----------------------------------------------|--------------|
| --client-server | Адрес по которому буду обслуживаться автобусы | 127.0.0.1    |
| --port          | Порт для автобусов                            | 8080         |
| --bus-server    | Адрес куда подключаться из броузера           | 127.0.0.1    |
| --bp            | Порт куда подключаться из броузера            | 8000         |
| -verbose        | Выводить ли логи                              | False        |

### fake_bus.py

Полный список ```python fake_bus.py -h```

| Аргумент  | Описание                                                   | По-умолчанию        |
|-----------|------------------------------------------------------------|---------------------|
| --server  | Адрес по которому буду обслуживаться автобусы              | ws://127.0.0.1:8080 |
| --routes  | Сколько маршрутов должно быть                              | 10                  |
| --number  | Cколько автобусов выпустим на маршрут                      | 10                  |
| --sockets | На какое количество сокетов раскинуть автобусы             | 3                   |
| -emid     | Префикс для маршрутов                                      |                     |
| -timeout  | С какой скоростью отправлять новые координаты для маршрута | 1                   |
| -verbose  | Выводить ли подробные логи                                 | False               |

## Настройки фронтенд

Внизу справа на странице можно включить отладочный режим логгирования и указать нестандартный адрес веб-сокета.

<img src="screenshots/settings.png">

Настройки сохраняются в Local Storage браузера и не пропадают после обновления страницы. Чтобы сбросить настройки
удалите ключи из Local Storage с помощью Chrome Dev Tools —> Вкладка Application —> Local Storage.

Если что-то работает не так, как ожидалось, то начните с включения отладочного режима логгирования.

## Формат данных

Фронтенд ожидает получить от сервера JSON сообщение со списком автобусов:

```js
{
  "msgType"
:
  "Buses",
    "buses"
:
  [
    {"busId": "c790сс", "lat": 55.7500, "lng": 37.600, "route": "120"},
    {"busId": "a134aa", "lat": 55.7494, "lng": 37.621, "route": "670к"},
  ]
}
```

Те автобусы, что не попали в список `buses` последнего сообщения от сервера будут удалены с карты.

Фронтенд отслеживает перемещение пользователя по карте и отправляет на сервер новые координаты окна:

```js
{
  "msgType"
:
  "newBounds",
    "data"
:
  {
    "east_lng"
  :
    37.65563964843751,
      "north_lat"
  :
    55.77367652953477,
      "south_lat"
  :
    55.72628839374007,
      "west_lng"
  :
    37.54440307617188,
  }
,
}
```

## Используемые библиотеки фронтенд

- [Leaflet](https://leafletjs.com/) — отрисовка карты
- [loglevel](https://www.npmjs.com/package/loglevel) для логгирования

## Цели проекта

Код написан в учебных целях — это урок в курсе по Python и веб-разработке на сайте [Devman](https://dvmn.org).
